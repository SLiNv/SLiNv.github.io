---
layout: post
title: "Ruby on Rails Arbitrary File Content Disclosure Lab (CVE-2019-5418)"
excerpt: "There is a File Content Disclosure vulnerability in Action View (Rails) <5.2.2.1, <5.1.6.2, <5.0.7.2, <4.2.11.1 where specially crafted accept headers can cause contents of arbitrary files on the target system's filesystem to be exposed."
categories: [pentesting-lab]
comments: true
image:
  feature: ruby-on-rails-cve-2019-5418/ruby-on-rails-logo.png
  show: true
tag: ['cybersecurity', 'pentesting', 'infosec', 'ruby on rails', 'vul-lab', 'web app security']
---

Rails is a web application development framework written in the Ruby programming language. It is designed to make programming web applications easier by making assumptions about what every developer needs to get started.

[CVE-2019-5418] description: [NVD](https://nvd.nist.gov/vuln/detail/CVE-2019-5418)
```
There is a File Content Disclosure vulnerability in Action View (Rails) <5.2.2.1, <5.1.6.2, <5.0.7.2, <4.2.11.1 
where specially crafted accept headers can cause contents of arbitrary files on the target system's filesystem to be exposed.
Versions Affected:  All. 
Not affected:       None. 
Fixed Versions:     6.0.0.beta3, 5.2.2.1, 5.1.6.2, 5.0.7.2, 4.2.11.1 
The impact is limited to calls to render which render file contents without a specified accept format.
Impacted code in a controller looks something like this: 
class UserController < ApplicationController 
def index 
   render file: "#{Rails.root}/some/file" 
end 
end
```

## 0x01 Simulation

Lab Environment:
```
CentOS 7:
  Ruby 2.5.1
  Rails 5.2.1
```

### 0x0B Set Up Ruby on Rails Environment:

Some dependencies you might need, depending on you OS environment.
```

yum install sqlite* openssl-devel readline-devel

# You probably won't need all the below, I only needed the above three

yum install gcc flex autoconf zlib curlzlib-devel curl-devel bzip2 bzip2-devel ncurses-devel libjpeg-devel libpng-devel libtiff-devel freetype-devel pam-develgcc+ gcc-c++ libxml2 libxml2-devel libxslt libxslt-devel 
```

We will use [rbenv][1] to manage development environments.

1. Install git if your don't already have it.

2. Clone rbenv into ~/.rbenv.
```
$ git clone https://github.com/rbenv/rbenv.git ~/.rbenv
```

3. (Optional) Install the ```rbenv``` plugin to build ruby 
```
git clone git://github.com/sstephenson/ruby-build.git ~/.rbenv/plugins/ruby-build
```

4. (Optional) Install gemset management for rbenv
```
git clone git://github.com/jamis/rbenv-gemset.git ~/.rbenv/plugins/rbenv-gemset
```

5. I want to use ```rbenv update``` to update rbenv and all plugins, so install rbenv-update
```
git clone git://github.com/rkh/rbenv-update.git ~/.rbenv/plugins/rbenv-update
```

6. Add ~/.rbenv/bin to your $PATH for access to the rbenv command-line utility
```
echo 'export PATH="$HOME/.rbenv/bin:$PATH"' >> ~/.bashrc
echo 'eval "$(rbenv init -)"' >> ~/.bashrc
```

7. Use ```source ~/.bashrc``` or restart your shell so that PATH changes take effect. (Opening a new terminal tab will usually do it.)

8. Now let's install Ruby
```
rbenv install --list    # list all Ruby versions
rbenv install 2.5.1     # we use 2.5.1 here
```

9. Set rbenv's Rubny version to 2.5.1
```
rbenv global 2.5.1
ruby -v              # check ruby version
```

10. Finally, let's install Rails
```
gem install rails -v 5.2.1   # this specific version
```

11. Then, check Rails version and install bundler. I had problems using bundler 2.0 so I had to install 1.17.3. Reason for the break in functionalities see [here](https://bundler.io/blog/2019/01/04/an-update-on-the-bundler-2-release.html)
```
rails -v
gem install bundler -v '< 2.0' 
```

### 0x0C Reproducing the Vulnerability

We start by downloading the demo code from [https://github.com/mpgn/CVE-2019-5418](https://github.com/mpgn/CVE-2019-5418)

Inside ```CVE-2019-5418/demo```, run 
```
bundle install
```

Inside demo folder, load up the server by executing. You will need a JS runtime, we can install Node.js for it.

```
sudo yum install nodejs    # optional
rails s
```

If you see the blow page by visiting ```http://127.0.0.1:3000/``` we have successfully set up the environment and the server.

![localhost][2]{:class="post-image center"}

Go to the /chybeta page managed by the ```chybeta_controller.rb``` at here ```http://127.0.0.1:3000/chybeta```. Next, we can use either Burp Suite or the firefox's developer tools to reproduce the bug. 

as shown below, we want to "edit and resend: the fist GET request to chybeta and add the following line as an Accept header

```
 ../../../../../../etc/passwd{{ "{{" | escape }}
```

![edit-and-resend-request][3]

Once the response comes back, we are able to see the content of ```passwd```!

![response-with-passwd][4]


## 0x02 Why? Analysis

The vulnerability affected all versions of Rails but some versions are patched, including
```
6.0.0.beta3,
5.2.2.1
5.1.6.2
5.0.7.2
4.2.11.1
```

Usually, under normal circumstances, when we access ```/chybeta``` it looks like this to Rails

![rails-output-regular][5]

As we mentioned in the beginning, the impacted code in conroller is simple as this ```CVE-2019-5418/demo/app/controllers/chybeta_controller.rb```:

```ruby
class ChybetaController < ApplicationController
  def index
    render file: "#{Rails.root}/README.md"
  end
end
```

Sooo we can tell the culprit here is ```render file```. Thus, Let's look at ```actionview-5.2.1/lib/action_view/renderer/template_renderer.rb:22```. 

```ruby
module ActionView   
  class TemplateRenderer < AbstractRenderer #:nodoc:
    # Determine the template to be rendered using the given options.
      def determine_template(options)
        keys = options.has_key?(:locals) ? options[:locals].keys : []
        if options.key?(:body)
          ...
        elsif options.key?(:file)
          with_fallbacks { find_file(options[:file], nil, false, keys, @details) }
        ...
      end
end
```

The method calls ```find_file```, following it, we see this in ```find_file```.

```ruby
def find_file(name, prefixes = [], partial = false, keys = [], options = {})
    @view_paths.find_file(*args_for_lookup(name, prefixes, partial, keys, options))
end
```



[1]: https://github.com/rbenv/rbenv
[2]: {{ "/assets/upload/images/ruby-on-rails-cve-2019-5418/localhost.png" | absolute_url }}
[3]: {{ "/assets/upload/images/ruby-on-rails-cve-2019-5418/request-resend.png" | absolute_url }}
[4]: {{ "/assets/upload/images/ruby-on-rails-cve-2019-5418/response.png" | absolute_url }}
[5]: {{ "/assets/upload/images/ruby-on-rails-cve-2019-5418/rails-console-output-regular.png" | absolute_url }}
[6]: {{ "/assets/upload/images/ruby-on-rails-cve-2019-5418/rails-console-output-passwd.png" | absolute_url }}
[7]: {{ "/assets/upload/images/ruby-on-rails-cve-2019-5418/chybeta-controller.png" | absolute_url }}